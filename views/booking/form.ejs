<%- include('../partials/header') %>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white py-4">
          <h3 class="mb-1">
            <i class="bi bi-calendar-plus"></i> Form Booking
          </h3>
          <p class="mb-0 text-white-50">Lapangan: <strong><%= field.name %></strong></p>
        </div>
        <div class="card-body p-4">
          <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="bi bi-exclamation-triangle"></i> <%= error %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>

          <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>Harga:</strong> Rp <%= Number(field.price).toLocaleString('id-ID') %> / Jam
          </div>

          <form method="POST" action="/booking/<%= field.id %>">
            <div class="mb-3">
              <label class="form-label fw-semibold">Tanggal Booking</label>
              <input 
                type="date" 
                name="booking_date" 
                class="form-control" 
                min="<%= new Date().toISOString().split('T')[0] %>"
                required 
              />
              <small class="text-muted">Pilih tanggal minimal hari ini</small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Jam Mulai</label>
                <input 
                  type="time" 
                  name="start_time" 
                  id="start_time"
                  class="form-control" 
                  required 
                />
                <div id="conflictStart" class="mt-2" style="display:none;">
                  <small class="text-danger">
                    <i class="bi bi-exclamation-circle"></i>
                    <strong>⚠️ Jam ini tidak tersedia!</strong>
                  </small>
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Jam Selesai</label>
                <input 
                  type="time" 
                  name="end_time" 
                  id="end_time"
                  class="form-control" 
                  required 
                />
                <div id="conflictEnd" class="mt-2" style="display:none;">
                  <small class="text-danger">
                    <i class="bi bi-exclamation-circle"></i>
                    <strong>⚠️ Jam ini tidak tersedia!</strong>
                  </small>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-semibold">Catatan (Opsional)</label>
              <textarea 
                name="note" 
                class="form-control" 
                placeholder="Masukkan catatan atau request khusus"
                rows="3"
              ></textarea>
            </div>

            <div class="d-grid gap-2">
              <button class="btn btn-primary btn-lg fw-semibold" type="submit">
                <i class="bi bi-check-circle"></i> Lakukan Booking
              </button>
              <a href="/fields" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Kembali ke Daftar
              </a>
            </div>
          </form>

          <hr class="my-4">

          <div class="alert alert-warning">
            <strong><i class="bi bi-lightbulb"></i> Informasi Penting:</strong>
            <ul class="mb-0 mt-2 small">
              <li><strong>Sistem Validasi Otomatis:</strong> Jika ada booking lain di jam yang sama untuk tanggal yang dipilih, booking Anda akan ditolak</li>
              <li>Booking akan diproses dengan status "Pending" menunggu persetujuan admin</li>
              <li>Lihat status booking Anda di Dashboard</li>
              <li>Pastikan jam mulai lebih kecil dari jam selesai</li>
            </ul>
          </div>

          <% if (bookings && bookings.length > 0) { %>
            <div class="alert alert-info mt-4">
              <strong><i class="bi bi-calendar-check"></i> Jadwal Terisi:</strong>
              <div class="mt-3">
                <% bookings.forEach(booking => { %>
                  <div class="mb-2 p-2 bg-light rounded border-start border-danger">
                    <strong><%= booking.booking_date %></strong>
                    <span class="text-danger">
                      <i class="bi bi-x-circle"></i> 
                      <%= booking.start_time %> - <%= booking.end_time %>
                    </span>
                    <span class="badge bg-secondary ms-2"><%= booking.status %></span>
                  </div>
                <% }); %>
              </div>
            </div>
          <% } %>

          <script>
            // Data booking dari server
            const bookingsData = <%- JSON.stringify(bookings || []) %>;

            function timeToMinutes(timeStr) {
              if (!timeStr) return null;
              const [h, m] = timeStr.split(':').map(Number);
              return h * 60 + m;
            }

            function hasConflict(date, startTime, endTime) {
              const startMinutes = timeToMinutes(startTime);
              const endMinutes = timeToMinutes(endTime);
              
              if (startMinutes === null || endMinutes === null) return false;

              return bookingsData.some(booking => {
                // Check if date matches
                if (booking.booking_date !== date) return false;
                
                const bookingStart = timeToMinutes(booking.start_time);
                const bookingEnd = timeToMinutes(booking.end_time);
                
                // Check for time overlap
                return startMinutes < bookingEnd && endMinutes > bookingStart;
              });
            }

            // Validasi real-time jam
            const startInput = document.getElementById('start_time');
            const endInput = document.getElementById('end_time');
            const dateInput = document.querySelector('input[name="booking_date"]');
            const conflictStartDiv = document.getElementById('conflictStart');
            const conflictEndDiv = document.getElementById('conflictEnd');
            const submitBtn = document.querySelector('button[type="submit"]');

            function updateConflictStatus() {
              const date = dateInput.value;
              const startTime = startInput.value;
              const endTime = endInput.value;

              if (!date || !startTime || !endTime) return;

              const hasConflictStatus = hasConflict(date, startTime, endTime);
              
              if (hasConflictStatus) {
                conflictStartDiv.style.display = 'block';
                conflictEndDiv.style.display = 'block';
                startInput.classList.add('is-invalid');
                endInput.classList.add('is-invalid');
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50');
              } else {
                conflictStartDiv.style.display = 'none';
                conflictEndDiv.style.display = 'none';
                startInput.classList.remove('is-invalid');
                endInput.classList.remove('is-invalid');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50');
              }
            }

            dateInput.addEventListener('change', updateConflictStatus);
            startInput.addEventListener('change', function() {
              const endTime = endInput.value;
              if (this.value && endTime && this.value >= endTime) {
                alert('⚠️ Jam mulai harus lebih kecil dari jam selesai!');
                this.value = '';
              }
              updateConflictStatus();
            });

            endInput.addEventListener('change', function() {
              const startTime = startInput.value;
              if (startTime && this.value && startTime >= this.value) {
                alert('⚠️ Jam selesai harus lebih besar dari jam mulai!');
                this.value = '';
              }
              updateConflictStatus();
            });
          </script>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
